<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Molly Server - Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Add this to the head section of your dashboard.html file, replacing any existing Socket.IO script -->
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-50 min-h-screen">
<!-- Toast notification system -->
<div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-2"></div>

<!-- Loading overlay -->
<div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[9999]">
    <div class="bg-white p-8 rounded-lg shadow-lg flex flex-col items-center max-w-md mx-4">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-600 mb-6"></div>
        <p id="loadingMessage" class="text-gray-800 text-lg font-medium text-center">Loading...</p>
    </div>
</div>

<div class="flex flex-col md:flex-row h-screen">
    <!-- Sidebar -->
    <div class="w-full md:w-72 bg-gradient-to-b from-indigo-800 to-indigo-900 text-white p-4 md:h-screen overflow-y-auto flex flex-col">
        <div class="flex items-center justify-center p-4 mb-6">
            <svg class="w-10 h-10 mr-3" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="40" fill="white" />
                <path d="M35 35 L65 65 M35 65 L65 35" stroke="#4f46e5" stroke-width="8" stroke-linecap="round" />
                <circle cx="50" cy="50" r="20" fill="#4f46e5" stroke="white" stroke-width="2" />
                <circle cx="50" cy="50" r="10" fill="white" />
            </svg>
            <span class="text-xl font-bold">Molly Pro</span>
        </div>
        
        <div class="mb-6">
            <h3 class="text-lg font-medium mb-2 px-2">Server & IP Management</h3>
            <ul class="space-y-1">
                <li>
                    <a href="#" id="getServerBtn" class="flex items-center p-3 rounded-lg hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-server w-6"></i>
                        <span class="ml-2">Buy Engine</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Server details moved to sidebar -->
        <div id="sidebarServerDetails" class="hidden bg-indigo-700 rounded-lg p-4 mb-4">
            <h3 class="text-lg font-medium mb-3">Cloud Details</h3>
            
            <div class="space-y-3 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-indigo-200">Status:</span>
                    <div id="statusBadge" class="px-3 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-800">
                        Initializing
                    </div>
                </div>
                
                <div>
                    <span class="text-sm font-medium text-indigo-200">Proxy:</span>
                    <p id="serverIP" class="text-base font-semibold flex items-center mt-1">
                        <span>-</span>
                        <button id="copyIPBtn" class="ml-2 text-white hover:text-indigo-200" title="Copy IP">
                            <i class="fas fa-copy"></i>
                        </button>
                    </p>
                </div>
                
                <div>
                    <span class="text-sm font-medium text-indigo-200">Engine Type:</span>
                    <p id="serverType" class="text-base font-semibold mt-1">-</p>
                </div>
                
                <div>
                    <span class="text-sm font-medium text-indigo-200">Created At:</span>
                    <p id="createdAt" class="text-base font-semibold mt-1">-</p>
                </div>
                
                <div>
                    <span class="text-sm font-medium text-indigo-200">Expires At:</span>
                    <p id="expiresAt" class="text-base font-semibold mt-1">-</p>
                </div>
            </div>
            
            <div class="space-y-2">
                <button id="connectBtn" class="w-full px-4 py-2 bg-white text-indigo-800 rounded-lg hover:bg-indigo-100 transition-colors flex items-center justify-center">
                    <i class="fas fa-plug mr-2"></i>
                    <span>Create Bridge </span>
                </button>
                
                <div id="connectingSpinner" class="hidden w-full px-4 py-2 bg-indigo-100 text-indigo-800 rounded-lg flex items-center justify-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-t-2 border-indigo-600 mr-2"></div>
                    <span>Connecting...</span>
                </div>
                
                <button id="getNewIPBtn" class="hidden w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                    <i class="fas fa-exchange-alt mr-2"></i>
                    <span>Change Proxy</span>
                </button>
                
                <button id="terminateBtn" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center">
                    <i class="fas fa-times-circle mr-2"></i>
                    <span>Terminate Engine</span>
                </button>
            </div>
            
            <div id="serverError" class="mt-4 hidden">
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded-lg" role="alert">
                    <div class="flex">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
                        <div>
                            <p class="font-medium text-sm">Error: <span id="serverErrorText"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Spacer that pushes logout to bottom -->
        <div class="flex-grow"></div>
        
        <!-- Logout button at bottom of sidebar -->
        <div>
            <a href="#" id="logoutBtn" class="flex items-center p-3 rounded-lg hover:bg-indigo-700 transition-colors">
                <i class="fas fa-sign-out-alt w-6"></i>
                <span class="ml-2">Logout</span>
            </a>
        </div>
    </div>

    <!-- Main content -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top navbar with user info and balance -->
        <header class="bg-white shadow-sm p-4 flex items-center justify-between">
            <h1 class="text-xl font-semibold text-gray-800">Operations & Analytics Hub</h1>
            
            <!-- User profile and balance - dropdown on right -->
            <div class="relative group">
                <div class="flex items-center cursor-pointer">
                    <div class="bg-indigo-700 rounded-lg p-2 mr-3 hidden md:block">
                        <div class="text-white text-sm font-medium flex items-center">
                            <i class="fas fa-coins mr-2"></i>
                            <span id="mollyPoints">--</span> <span class="ml-1">Credits</span>
                            <button id="refreshPointsBtn" class="ml-2 text-indigo-200 hover:text-white" title="Refresh Balance">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <span class="mr-2 text-gray-700 hidden md:inline" id="username">--</span>
                        <div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-lg">
                            <span id="userInitial">-</span>
                        </div>
                        <i class="fas fa-chevron-down ml-2 text-gray-500 text-xs"></i>
                    </div>
                </div>
                
                <!-- Dropdown menu -->
                <div class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-2 hidden group-hover:block z-10">
                    <div class="px-4 py-2 border-b border-gray-100">
                        <p id="usernameDropdown" class="font-medium">--</p>
                        <p class="text-sm text-gray-500">User</p>
                    </div>
                    <div class="px-4 py-2 border-b border-gray-100">
                        <p class="text-sm text-gray-500">Balance</p>
                        <p class="font-medium flex items-center">
                            <i class="fas fa-coins mr-2 text-indigo-600"></i>
                            <span id="mollyPointsDropdown">--</span> Credits
                            <button id="refreshPointsDropdownBtn" class="ml-2 text-indigo-400 hover:text-indigo-600" title="Refresh Balance">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </p>
                    </div>
                    <a href="#" id="logoutBtnDropdown" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        <i class="fas fa-sign-out-alt mr-2"></i> Logout
                    </a>
                </div>
            </div>
        </header>

        <!-- Main content area -->
        <main class="flex-1 overflow-auto p-4">
            <div id="welcomeSection" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">Welcome to Molly Pro!</h2>
                <p class="mb-4 text-gray-600">This isn’t just a dashboard. It’s your command center. Your war room. Your digital missile launchpad. 💥</p>
<p class="mb-4 text-gray-600">Spin up servers like a mad scientist, swap IPs like a ghost in the machine, and flood inboxes with precision.</p>
<p class="mb-4 text-gray-600">No limits. No mercy. Just raw, unfiltered email domination.</p>
<p class="text-gray-600">Hit that **"BUY ENGINE "** button and make the internet your playground. 🚀</p>
                
                <div class="mt-6">
                    <button id="getServerBtnMain" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center">
                        <i class="fas fa-server mr-2"></i>
                        <span>BUY ENGINE NOW</span>
                    </button>
                </div>
            </div>

            <!-- Email sender section (initially hidden) -->
            <div id="emailSenderSection" class="hidden h-full overflow-auto">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-6">Molly Mailer</h2>
                    
                    <!-- Dynamic Tags Section (Updated) -->
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3">Inbox Nukes 💣</h3>
                        <div class="flex flex-wrap gap-2">
                            <div class="inline-flex items-center px-3 py-1.5 bg-indigo-100 text-indigo-800 rounded-lg cursor-pointer hover:bg-indigo-200 tag-item" data-tag="$email">
                                <span class="mr-1">$email</span>
                                <i class="fas fa-copy text-xs"></i>
                            </div>
                            <div class="inline-flex items-center px-3 py-1.5 bg-indigo-100 text-indigo-800 rounded-lg cursor-pointer hover:bg-indigo-200 tag-item" data-tag="$ranId">
                                <span class="mr-1">$ranId</span>
                                <i class="fas fa-copy text-xs"></i>
                            </div>
                            <!-- Added date tag -->
                            <div class="inline-flex items-center px-3 py-1.5 bg-indigo-100 text-indigo-800 rounded-lg cursor-pointer hover:bg-indigo-200 tag-item" data-tag="$date">
                                <span class="mr-1">$date</span>
                                <i class="fas fa-copy text-xs"></i>
                            </div>
                            <!-- Added invoice tag -->
                            <div class="inline-flex items-center px-3 py-1.5 bg-indigo-100 text-indigo-800 rounded-lg cursor-pointer hover:bg-indigo-200 tag-item" data-tag="$invoice">
                                <span class="mr-1">$invoice</span>
                                <i class="fas fa-copy text-xs"></i>
                            </div>
                            <!-- Custom tags will be added here dynamically -->
                            <div id="customTagsList"></div>
                            
                            <button id="addCustomTagBtn" class="px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus mr-1"></i> Add Custom Nukes 💣
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">Click a tag to copy it to clipboard. Use these tags in your email content and they will be replaced with actual values.</p>
                    </div>

                    <!-- SMTP Validation Results (initially hidden) -->
                    <div id="smtpValidationResults" class="mb-6 hidden">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-medium">SMTP Validation Results</h3>
                            <button id="downloadSmtpLogsBtn" class="hidden px-3 py-1.5 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 flex items-center">
                                <i class="fas fa-download mr-1"></i> Download Logs
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="bg-green-100 p-4 rounded-lg">
                                <p class="font-medium text-green-800">Valid SMTPs: <span id="validSmtpCount">0</span></p>
                            </div>
                            <div class="bg-red-100 p-4 rounded-lg">
                                <p class="font-medium text-red-800">Invalid SMTPs: <span id="invalidSmtpCount">0</span></p>
                            </div>
                        </div>
                        <div id="smtpErrorsList" class="bg-gray-50 p-4 rounded-lg max-h-60 overflow-y-auto hidden">
                            <h4 class="font-medium mb-2">SMTP Errors:</h4>
                            <ul class="space-y-2"></ul>
                        </div>
                    </div>
                    
                    <form id="emailForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <label class="block text-sm font-medium text-gray-700">Upload SMTP List</label>
                                    <button id="clearSmtpBtn" class="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 hidden">
                                        <i class="fas fa-times mr-1"></i>Clear
                                    </button>
                                </div>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-500 transition-colors relative group">
                                    <input type="file" id="smtpFile" accept=".csv" class="hidden">
                                    <label for="smtpFile" class="cursor-pointer flex flex-col items-center">
                                        <i class="fas fa-upload text-gray-400 text-2xl mb-2"></i>
                                        <span class="text-sm text-gray-600">Click to upload SMTP CSV</span>
                                        <span id="smtpFileName" class="text-xs text-indigo-600 mt-2 hidden"></span>
                                    </label>
                                    <!-- SMTP CSV Hover Preview -->
                                    <div class="hidden group-hover:block absolute left-0 right-0 -bottom-1 transform translate-y-full z-10">
                                        <div id="smtpHoverPreview" class="bg-white p-3 rounded-lg border border-gray-200 shadow-lg max-h-60 overflow-y-auto hidden">
                                            <div class="text-xs">
                                                <table class="min-w-full divide-y divide-gray-200">
                                                    <thead class="bg-gray-100">
                                                        <tr id="smtpHoverPreviewHeader"></tr>
                                                    </thead>
                                                    <tbody id="smtpHoverPreviewBody" class="bg-white divide-y divide-gray-200"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="smtpFileError" class="text-sm text-red-600 hidden"></div>
                                
                                <!-- SMTP CSV Preview -->
                                <div id="smtpPreviewContainer" class="hidden mt-3">
                                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="text-sm font-medium text-gray-700">CSV Preview</h4>
                                            <span class="text-xs text-gray-500">First 5 rows</span>
                                        </div>
                                        <div class="overflow-x-auto max-h-40 text-xs">
                                            <table id="smtpPreviewTable" class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-100">
                                                    <tr id="smtpPreviewHeader"></tr>
                                                </thead>
                                                <tbody id="smtpPreviewBody" class="bg-white divide-y divide-gray-200"></tbody>
                                            </table>
                                        </div>
                                        <div class="mt-2 text-xs text-right">
                                            <span id="smtpRowCount" class="text-indigo-600 font-medium">0</span> total rows
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <label class="block text-sm font-medium text-gray-700">Upload Email List</label>
                                    <button id="clearEmailBtn" class="text-xs px-2 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 hidden">
                                        <i class="fas fa-times mr-1"></i>Clear
                                    </button>
                                </div>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-500 transition-colors relative group">
                                    <input type="file" id="emailFile" accept=".csv" class="hidden">
                                    <label for="emailFile" class="cursor-pointer flex flex-col items-center">
                                        <i class="fas fa-upload text-gray-400 text-2xl mb-2"></i>
                                        <span class="text-sm text-gray-600">Click to upload Email CSV</span>
                                        <span id="emailFileName" class="text-xs text-indigo-600 mt-2 hidden"></span>
                                    </label>
                                    <!-- Email CSV Hover Preview -->
                                    <div class="hidden group-hover:block absolute left-0 right-0 -bottom-1 transform translate-y-full z-10">
                                        <div id="emailHoverPreview" class="bg-white p-3 rounded-lg border border-gray-200 shadow-lg max-h-60 overflow-y-auto hidden">
                                            <div class="text-xs">
                                                <table class="min-w-full divide-y divide-gray-200">
                                                    <thead class="bg-gray-100">
                                                        <tr id="emailHoverPreviewHeader"></tr>
                                                    </thead>
                                                    <tbody id="emailHoverPreviewBody" class="bg-white divide-y divide-gray-200"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="emailFileError" class="text-sm text-red-600 hidden"></div>
                                
                                <!-- Email CSV Preview -->
                                <div id="emailPreviewContainer" class="hidden mt-3">
                                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                        <div class="flex justify-between items-center mb-2">
                                            <h4 class="text-sm font-medium text-gray-700">CSV Preview</h4>
                                            <span class="text-xs text-gray-500">First 5 rows</span>
                                        </div>
                                        <div class="overflow-x-auto max-h-40 text-xs">
                                            <table id="emailPreviewTable" class="min-w-full divide-y divide-gray-200">
                                                <thead class="bg-gray-100">
                                                    <tr id="emailPreviewHeader"></tr>
                                                </thead>
                                                <tbody id="emailPreviewBody" class="bg-white divide-y divide-gray-200"></tbody>
                                            </table>
                                        </div>
                                        <div class="mt-2 text-xs text-right">
                                            <span id="emailRowCount" class="text-indigo-600 font-medium">0</span> total rows
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label for="subject" class="block text-sm font-medium text-gray-700">Email Subject</label>
                                <input type="text" id="subject" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                            </div>
                            <div class="space-y-2">
                                <label for="senderName" class="block text-sm font-medium text-gray-700">Display Name</label>
                                <input type="text" id="senderName" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label for="plainMessage" class="block text-sm font-medium text-gray-700">MIME Plain Text </label>
                            <textarea id="plainMessage" rows="3" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"></textarea>
                        </div>
                        
                        <div class="space-y-2">
                            <label for="htmlMessage" class="block text-sm font-medium text-gray-700">Rich Text Email</label>
                            <textarea id="htmlMessage" rows="3" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label for="attachmentType" class="block text-sm font-medium text-gray-700">Attachment Type</label>
                                <select id="attachmentType" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                                    <option value="none">None</option>
                                    <option value="pdf">PDF</option>
                                    <option value="jpeg">JPEG</option>
                                    <option value="png">PNG</option>
                                    <option value="word">Word</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label for="delay" class="block text-sm font-medium text-gray-700">Delay (seconds)</label>
                                <input type="number" id="delay" min="0" value="5" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                            </div>
                            <div class="space-y-2">
                                <label for="threads" class="block text-sm font-medium text-gray-700">Threads</label>
                                <input type="number" id="threads" min="1" max="50" value="10" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <label for="attachmentName" class="block text-sm font-medium text-gray-700">Attachment Name</label>
                            <input type="text" id="attachmentName" placeholder="e.g. document-$ranId" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                        </div>
                        
                        <div class="space-y-2">
                            <label for="attachmentHtml" class="block text-sm font-medium text-gray-700">Attachment CONTENT</label>
                            <textarea id="attachmentHtml" rows="3" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border"></textarea>
                        </div>
                        
                        <div class="pt-4 flex space-x-4">
                            <button type="submit" id="sendBtn" class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Send Emails
                            </button>
                            <button type="button" id="sendingBtn" class="hidden inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-indigo-500" disabled>
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Sending...
                            </button>
                            <!-- Added Stop Button -->
                            <button type="button" id="stopSendingBtn" class="hidden inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                                <i class="fas fa-stop mr-2"></i>
                                Stop Sending
                            </button>
                        </div>
                    </form>
                    
                    <!-- Progress section (initially hidden) -->
                    <div id="progressSection" class="mt-8 hidden">
                        <h3 class="text-lg font-medium mb-4">Email Sending Progress</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                <h4 class="text-sm font-medium text-gray-500">SMTP Failed</h4>
                                <p id="smtpFailed" class="text-xl font-bold text-red-600">0</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                <h4 class="text-sm font-medium text-gray-500">SMTP Successful</h4>
                                <p id="smtpSuccess" class="text-xl font-bold text-green-600">0</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                <h4 class="text-sm font-medium text-gray-500">Emails Sent</h4>
                                <p id="emailsSent" class="text-xl font-bold text-green-600">0</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                <h4 class="text-sm font-medium text-gray-500">Emails Failed</h4>
                                <p id="emailsFailed" class="text-xl font-bold text-red-600">0</p>
                            </div>
                        </div>
                        
                        <div class="relative pt-1">
                            <div class="flex mb-2 items-center justify-between">
                                <div>
                                    <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-100">
                                        Progress
                                    </span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-semibold inline-block text-indigo-600">
                                        <span id="progressPercentage">0</span>%
                                    </span>
                                </div>
                            </div>
                            <div class="overflow-hidden h-2 mb-4 text-xs flex rounded-full bg-indigo-100">
                                <div id="progressBar" style="width:0%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-600 transition-all duration-500"></div>
                            </div>
                        </div>
                        
                        <!-- Failed emails download section -->
                        <div id="failedEmailsSection" class="mt-4 hidden">
                            <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-medium text-red-800">Failed Emails</h4>
                                        <p class="text-sm text-red-600 mt-1">Some emails failed to send. Download the list to see why they failed.</p>
                                    </div>
                                    <button id="downloadFailedBtn" class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 flex items-center">
                                        <i class="fas fa-download mr-1"></i> Download Logs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Server selection modal -->
<div id="serverModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-xl font-semibold mb-4">Buy Engine</h2>
        <p class="mb-6 text-gray-600">Select Engine type:</p>
        
        <div class="space-y-4">
            <div id="singleServerOption" class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">Basic - No Proxy</h3>
                    <span class="text-indigo-600 font-bold">100 Molly Credits</span>
                </div>
                <p class="text-sm text-gray-600">Valid for 2 hours</p>
            </div>
            
            <div id="unlimitedServerOption" class="border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition-colors">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-medium">Advanced - Ip Swaps</h3>
                    <span class="text-indigo-600 font-bold">2000 Molly Credits</span>
                </div>
                <p class="text-sm text-gray-600">Valid for 12 hours</p>
            </div>
        </div>
        
        <div class="mt-6 flex justify-end space-x-3">
            <button id="cancelServerBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                Cancel
            </button>
        </div>
        
        <div id="serverModalError" class="mt-4 hidden">
            <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert">
                <p id="serverModalErrorText" class="font-medium"></p>
            </div>
        </div>
    </div>
</div>

<!-- Get New IP confirmation modal -->
<div id="newIPModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-xl font-semibold mb-4">Change Proxy</h2>
        <div class="mb-6">
            <p class="text-gray-600 mb-3">Are you sure you want to get a new IP address?</p>
            <p class="text-indigo-600 font-medium">Your current IP address will be replaced with a new one.</p>
            <div class="mt-4 bg-blue-50 p-3 rounded-lg border border-blue-100">
                <p class="text-sm text-blue-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    The system will allocate a fresh IP address for your Engine. Your existing connection will be reset.
                </p>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button id="cancelNewIPBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                Cancel
            </button>
            <button id="confirmNewIPBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors">
                Change Proxy
            </button>
        </div>
    </div>
</div>

<!-- Add Custom Tag Modal -->
<div id="customTagModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl">
        <h2 class="text-xl font-semibold mb-4">Add Custom Tag</h2>
        <div class="space-y-4 mb-6">
            <div>
                <label for="tagName" class="block text-sm font-medium text-gray-700 mb-1">Tag Name</label>
                <input type="text" id="tagName" placeholder="e.g. customId" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                <p class="text-xs text-gray-500 mt-1">Will be used as $tagName in your content</p>
            </div>
            
            <div>
                <label for="tagType" class="block text-sm font-medium text-gray-700 mb-1">Character Type</label>
                <select id="tagType" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                    <option value="alphanumeric">Alphanumeric (A-Z, a-z, 0-9)</option>
                    <option value="alpha">Alphabetic only (A-Z, a-z)</option>
                    <option value="numeric">Numeric only (0-9)</option>
                    <option value="hex">Hexadecimal (0-9, A-F)</option>
                </select>
            </div>
            
            <div>
                <label for="tagCase" class="block text-sm font-medium text-gray-700 mb-1">Letter Case</label>
                <select id="tagCase" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-4 py-2 border">
                    <option value="mixed">Mixed case (aB1)</option>
                    <option value="upper">Uppercase (AB1)</option>
                    <option value="lower">Lowercase (ab1)</option>
                </select>
            </div>
            
            <div>
                <label for="tagLength" class="block text-sm font-medium text-gray-700 mb-1">Length</label>
                <input type="range" id="tagLength" min="1" max="32" value="8" class="w-full">
                <div class="flex justify-between">
                    <span class="text-xs text-gray-500">1</span>
                    <span id="tagLengthValue" class="text-xs font-medium">8</span>
                    <span class="text-xs text-gray-500">32</span>
                </div>
            </div>
            
            <div class="p-3 bg-gray-50 rounded-lg">
                <h3 class="text-sm font-medium text-gray-700 mb-2">Preview:</h3>
                <p class="font-mono text-sm"><span class="text-indigo-600">$</span><span id="tagNamePreview">customId</span> → <span id="tagValuePreview" class="font-medium">Ab1X8p2Z</span></p>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button id="cancelCustomTagBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition-colors">
                Cancel
            </button>
            <button id="addCustomTagConfirmBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors">
                Add Tag
            </button>
        </div>
    </div>
</div>
<script>
    // Define the pulse animation if not already defined
    if (!document.getElementById('pulse-animation')) {
        const style = document.createElement('style');
        style.id = 'pulse-animation';
        style.textContent = `
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.6; }
            }
            
            .animate-pulse {
                animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
        `;
        document.head.appendChild(style);
    }
    
    // Store custom tags
    const customTags = {};
    
    // Global variable to store socket connection
    let activeSocket = null;
    let stopRequested = false;
    
    // Poll server status to check if it's ready after creation or IP rotation
    // Improved server creation monitoring with more frequent polling
function pollServerStatus(serverId) {
    if (!serverId) {
        console.error('Missing server ID for polling');
        return;
    }
    
    const token = localStorage.getItem('token');
    if (!token) {
        console.error('Missing token for polling server status');
        return;
    }
    
    console.log(`Starting to poll status for server ${serverId}`);
    
    // Poll more frequently initially, then back off
    let attempts = 0;
    const maxAttempts = 30;
    
    function calculateDelay() {
        // Start with 2 second polls, gradually increase up to 10 seconds
        return Math.min(2000 + (attempts * 500), 10000);
    }
    
    function checkStatus() {
        attempts++;
        fetch(`/api/server-status/${serverId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.server) {
                const server = data.server;
                console.log(`Server status: ${server.status}`, server);
                
                // Update the server IP in the UI
                const serverIP = document.getElementById('serverIP');
                if (serverIP) {
                    // First, check if the element already has a span
                    let span = serverIP.querySelector('span');
                    if (!span) {
                        // If not, create one
                        span = document.createElement('span');
                        serverIP.innerHTML = '';
                        serverIP.appendChild(span);
                    }
                    // Now update the span content
                    span.textContent = server.ip;
                }
                
                // Update the status badge based on server status
                let statusText;
                if (server.status === 'starting') {
                    statusText = 'Initializing';
                    updateStatusBadge('initializing');
                } else if (server.status === 'rotating_ip') {
                    statusText = 'Swapping IP';
                    updateStatusBadge('connecting');
                } else if (server.status === 'ready') {
                    statusText = 'Ready';
                    updateStatusBadge('running');
                } else if (server.status === 'error' || server.status === 'service_unavailable') {
                    statusText = 'Error';
                    updateStatusBadge('error');
                } else {
                    statusText = server.status || 'Unknown';
                    updateStatusBadge('initializing');
                }
                
                // Update status badge text if needed
                const statusBadge = document.getElementById('statusBadge');
                if (statusBadge) {
                    // Only update the text, keep the styling from updateStatusBadge
                    const iconElement = statusBadge.querySelector('i');
                    if (iconElement) {
                        // Keep the existing icon and just update the text
                        const textNode = statusBadge.childNodes[1];
                        if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                            textNode.textContent = ` ${statusText}`;
                        }
                    }
                }
                
                // Update buttons based on status
                const getNewIPBtn = document.getElementById('getNewIPBtn');
                const terminateBtn = document.getElementById('terminateBtn');
                
                // Enable/disable buttons based on status
                if (['starting', 'rotating_ip', 'rechecking'].includes(server.status)) {
                    if (getNewIPBtn) {
                        getNewIPBtn.disabled = true;
                        getNewIPBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                    if (terminateBtn) {
                        terminateBtn.disabled = true;
                        terminateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                } else {
                    if (getNewIPBtn) {
                        getNewIPBtn.disabled = false;
                        getNewIPBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                    if (terminateBtn) {
                        terminateBtn.disabled = false;
                        terminateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
                
                // Store updated server information
                const currentServer = JSON.parse(localStorage.getItem('currentServer') || '{}');
                currentServer.ip = server.ip;
                localStorage.setItem('currentServer', JSON.stringify(currentServer));
                
                // Continue polling if server is still in a transitional state
                if (['starting', 'rotating_ip', 'rechecking'].includes(server.status)) {
                    const delay = calculateDelay();
                    console.log(`Checking again in ${delay/1000} seconds (attempt ${attempts}/${maxAttempts})`);
                    if (attempts < maxAttempts) {
                        setTimeout(checkStatus, delay);
                    } else {
                        showToast('Server status check timed out. Please refresh the page to check again.', 'warning');
                    }
                } else if (server.status === 'ready') {
                    showToast('Server is ready!', 'success');
                } else if (server.status === 'error' || server.status === 'service_unavailable') {
                    showToast('Server encountered an error during setup', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error polling server status:', error);
            // Try again after a delay
            if (attempts < maxAttempts) {
                setTimeout(checkStatus, 10000); // Longer delay on error
            } else {
                showToast('Server status check timed out. Please refresh the page to check again.', 'warning');
            }
        });
    }
    
    // Start the polling
    checkStatus();
}
    
    // Toast notification system
    function showToast(message, type = 'info', duration = 5000) {
        const toast = document.createElement('div');
        
        let bgColor = 'bg-indigo-500';
        let icon = 'info-circle';
        
        if (type === 'success') {
            bgColor = 'bg-green-500';
            icon = 'check-circle';
        } else if (type === 'error') {
            bgColor = 'bg-red-500';
            icon = 'exclamation-circle';
        } else if (type === 'warning') {
            bgColor = 'bg-yellow-500';
            icon = 'exclamation-triangle';
        }
        
        toast.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center justify-between mb-2 transform transition-transform duration-300 ease-in-out`;
        toast.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${icon} mr-3"></i>
                <span>${message}</span>
            </div>
            <button class="ml-4 text-white focus:outline-none">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        
        // Add to container
        const container = document.getElementById('toast-container');
        container.appendChild(toast);
        
        // Apply entrance animation
        setTimeout(() => {
            toast.classList.add('translate-x-0');
        }, 10);
        
        // Remove toast after duration
        setTimeout(() => {
            toast.classList.add('opacity-0');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }, duration);
        
        // Close button
        toast.querySelector('button').addEventListener('click', () => {
            toast.classList.add('opacity-0');
            setTimeout(() => {
                toast.remove();
            }, 300);
        });
    }
    
    // Reliable copy to clipboard function that works in most browsers
    function copyToClipboard(text) {
        // First try the modern clipboard API
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    showToast(`Tag "${text}" copied to clipboard`, 'success', 2000);
                })
                .catch(err => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopy(text);
                });
        } else {
            fallbackCopy(text);
        }
        
        // Fallback method using document.execCommand
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';  // Avoid scrolling to bottom
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast(`Tag "${text}" copied to clipboard`, 'success', 2000);
                } else {
                    showToast('Failed to copy tag', 'error');
                }
            } catch (err) {
                console.error('execCommand failed:', err);
                showToast('Failed to copy tag', 'error');
            }
            
            document.body.removeChild(textarea);
        }
    }
    
    // Replace the existing copyTagToClipboard function with this one
    function copyTagToClipboard(tag) {
        copyToClipboard(tag);
    }
    
    // Update custom tag preview
    function updateTagPreview() {
        const name = document.getElementById('tagName').value || 'customId';
        const type = document.getElementById('tagType').value;
        const caseType = document.getElementById('tagCase').value;
        const length = document.getElementById('tagLength').value;
        
        document.getElementById('tagNamePreview').textContent = name;
        document.getElementById('tagLengthValue').textContent = length;
        
        // Generate a preview value
        const preview = generateRandomString(parseInt(length), type, caseType);
        document.getElementById('tagValuePreview').textContent = preview;
    }
    
    // Generate random string for preview
    function generateRandomString(length, type, caseType) {
        let chars = '';
        
        if (type === 'alphanumeric') {
            chars += (caseType === 'lower' || caseType === 'mixed') ? 'abcdefghijklmnopqrstuvwxyz' : '';
            chars += (caseType === 'upper' || caseType === 'mixed') ? 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' : '';
            chars += '0123456789';
        } else if (type === 'alpha') {
            chars += (caseType === 'lower' || caseType === 'mixed') ? 'abcdefghijklmnopqrstuvwxyz' : '';
            chars += (caseType === 'upper' || caseType === 'mixed') ? 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' : '';
        } else if (type === 'numeric') {
            chars = '0123456789';
        } else if (type === 'hex') {
            chars = '0123456789ABCDEF';
        }
        
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        
        return result;
    }
    
    // Modified addCustomTagToUI function
    function addCustomTagToUI(name, config) {
        const tagsList = document.getElementById('customTagsList');
        const tagId = `tag-${name}`;
        
        // Check if tag already exists
        if (document.getElementById(tagId)) {
            return; // Already exists
        }
        
        const tagElement = document.createElement('div');
        tagElement.id = tagId;
        tagElement.className = 'inline-flex items-center px-3 py-1.5 bg-blue-100 text-blue-800 rounded-lg cursor-pointer hover:bg-blue-200 tag-item';
        tagElement.setAttribute('data-tag', '$' + name);
        tagElement.setAttribute('data-has-handler', 'true');
        tagElement.innerHTML = `
            <span class="mr-1">${name}</span>
            <i class="fas fa-copy text-xs mr-1"></i>
            <i class="fas fa-times text-xs text-red-500 ml-1"></i>
        `;
        
        // Direct click handler instead of using attributes
        tagElement.addEventListener('click', function(e) {
            if (!e.target.classList.contains('fa-times')) {
                copyTagToClipboard('$' + name);
            }
        });
        
        // Remove tag when X is clicked
        const removeIcon = tagElement.querySelector('.fa-times');
        if (removeIcon) {
            removeIcon.addEventListener('click', function(e) {
                e.stopPropagation();
                delete customTags[name];
                tagElement.remove();
                showToast(`Custom tag ${name} removed`, 'info', 2000);
            });
        }
        
        tagsList.appendChild(tagElement);
    }
    
    // Show/hide loading overlay
    function showLoading(message = 'Loading...') {
        document.getElementById('loadingMessage').textContent = message;
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }
    
    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }
    
    // Helper function to handle API errors
    async function handleApiResponse(response) {
        const data = await response.json();
        
        if (!response.ok) {
            const errorMessage = data.message || 'An error occurred';
            throw new Error(errorMessage);
        }
        
        return data;
    }
    
    // Format date for display
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    
    // Format current date for date tag
    function getCurrentFormattedDate() {
        const now = new Date();
        return now.toLocaleString('en-US', {
            year: 'numeric', 
            month: 'long', 
            day: 'numeric'
        });
    }
    
    // Generate an invoice number
    function generateInvoiceNumber() {
        const now = new Date();
        const year = now.getFullYear().toString().substr(-2);
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        return `INV-${year}${month}-${random}`;
    }
    
    // Update server status badge
    function updateStatusBadge(state) {
        const badge = document.getElementById('statusBadge');
        
        if (state === 'connected') {
            badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800';
            badge.innerHTML = '<i class="fas fa-circle text-green-500 mr-1"></i> Connected';
        } else if (state === 'running') {
            badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800';
            badge.innerHTML = '<i class="fas fa-circle text-blue-500 mr-1"></i> Running';
        } else if (state === 'connecting') {
            badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800';
            badge.innerHTML = '<i class="fas fa-circle text-yellow-500 mr-1"></i> Connecting';
        } else if (state === 'error') {
            badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800';
            badge.innerHTML = '<i class="fas fa-circle text-red-500 mr-1"></i> Error';
        } else {
            badge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-800';
            badge.innerHTML = '<i class="fas fa-circle text-gray-500 mr-1"></i> Initializing';
        }
    }
    
    // Display SMTP validation results

function displaySmtpValidationResults(results) {
    const validationSection = document.getElementById('smtpValidationResults');
    const errorsList = document.getElementById('smtpErrorsList');
    const errorsContainer = errorsList.querySelector('ul');
    
    document.getElementById('validSmtpCount').textContent = results.valid_count;
    document.getElementById('invalidSmtpCount').textContent = results.invalid_count;
    
    // Clear previous errors
    errorsContainer.innerHTML = '';
    
    // Add errors to list with more details
    if (results.errors && results.errors.length > 0) {
        // Store the failed SMTPs for download
        window.failedSmtps = results.errors;
        
        results.errors.forEach(error => {
            const li = document.createElement('li');
            li.className = 'p-3 bg-red-50 rounded border border-red-100 mb-2';
            
            // Extract the specific error type
            let errorMessage = error.error;
            let errorType = "Connection error";
            
            if (errorMessage.includes("Authentication failed")) {
                errorType = "Authentication failed";
            } else if (errorMessage.includes("Connection timed out")) {
                errorType = "Connection timed out";
            } else if (errorMessage.includes("Connection refused")) {
                errorType = "Connection refused";
            } else if (errorMessage.includes("No such host")) {
                errorType = "Host not found";
            }
            
            li.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-medium">${error.username} (${error.smtp})</p>
                        <p class="text-sm text-red-700 mt-1">${errorMessage}</p>
                    </div>
                    <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">${errorType}</span>
                </div>
            `;
            errorsContainer.appendChild(li);
        });
        
        // Show errors list
        errorsList.classList.remove('hidden');
        
        // Show download button
        document.getElementById('downloadSmtpLogsBtn').classList.remove('hidden');
    } else {
        errorsList.classList.add('hidden');
        document.getElementById('downloadSmtpLogsBtn').classList.add('hidden');
    }
    
    // Show validation section
    validationSection.classList.remove('hidden');
    
    // Scroll to the validation results
    validationSection.scrollIntoView({ behavior: 'smooth' });
}

// Function to download failed SMTP logs
function downloadSmtpLogs() {
    if (!window.failedSmtps || window.failedSmtps.length === 0) {
        showToast('No failed SMTP records to download', 'error');
        return;
    }
    
    try {
        // Create CSV content
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Username,SMTP,Error,Error Type\n";
        
        window.failedSmtps.forEach(record => {
            let errorType = "Connection error";
            
            if (record.error.includes("Authentication failed")) {
                errorType = "Authentication failed";
            } else if (record.error.includes("Connection timed out")) {
                errorType = "Connection timed out";
            } else if (record.error.includes("Connection refused")) {
                errorType = "Connection refused";
            } else if (record.error.includes("No such host")) {
                errorType = "Host not found";
            }
            
            // Escape CSV values properly
            const username = `"${record.username.replace(/"/g, '""')}"`;
            const smtp = `"${record.smtp.replace(/"/g, '""')}"`;
            const error = `"${record.error.replace(/"/g, '""')}"`;
            
            csvContent += `${username},${smtp},${error},"${errorType}"\n`;
        });
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "failed_smtp_logs.csv");
        document.body.appendChild(link);
        
        // Trigger download
        link.click();
        
        // Clean up
        document.body.removeChild(link);
        
        showToast('SMTP logs downloaded successfully', 'success');
    } catch (error) {
        console.error('Error downloading SMTP logs:', error);
        showToast('Failed to download SMTP logs', 'error');
    }
}

// Enhance failed emails handling
let failedEmailsTimeout = null;

function updateEmailProgress(data) {
    const smtpFailed = document.getElementById('smtpFailed');
    const smtpSuccess = document.getElementById('smtpSuccess');
    const emailsSent = document.getElementById('emailsSent');
    const emailsFailed = document.getElementById('emailsFailed');
    const progressPercentage = document.getElementById('progressPercentage');
    const progressBar = document.getElementById('progressBar');
    const failedEmailsSection = document.getElementById('failedEmailsSection');
    const sendBtn = document.getElementById('sendBtn');
    const sendingBtn = document.getElementById('sendingBtn');
    const stopSendingBtn = document.getElementById('stopSendingBtn');
    
    if (smtpFailed) smtpFailed.textContent = data.smtpFailed;
    if (smtpSuccess) smtpSuccess.textContent = data.smtpSuccess;
    if (emailsSent) emailsSent.textContent = data.emailsSent;
    if (emailsFailed) emailsFailed.textContent = data.emailsFailed;
    
    const total = data.emailsSent + data.emailsFailed;
    const totalEmails = parseInt(data.totalEmails);
    const percentage = totalEmails > 0 ? Math.round((total / totalEmails) * 100) : 0;
    
    if (progressPercentage) progressPercentage.textContent = percentage;
    if (progressBar) progressBar.style.width = `${percentage}%`;
    
    // Show failed emails section if there are any failed emails
    if (data.emailsFailed > 0 && failedEmailsSection) {
        // Store failed emails data if available
        if (data.failedEmails) {
            window.failedEmails = data.failedEmails;
        }
        
        failedEmailsSection.classList.remove('hidden');
        
        // Clear any existing timeout
        if (failedEmailsTimeout) {
            clearTimeout(failedEmailsTimeout);
        }
        
        // Set timeout to hide the failed emails section after 20 seconds
        failedEmailsTimeout = setTimeout(() => {
            if (failedEmailsSection) {
                failedEmailsSection.classList.add('hidden');
            }
        }, 20000); // 20 seconds
    }
    
    if (total >= totalEmails && !data.isRunning) {
        // Re-enable send button when process is complete
        if (sendBtn) sendBtn.classList.remove('hidden');
        if (sendingBtn) sendingBtn.classList.add('hidden');
        if (stopSendingBtn) stopSendingBtn.classList.add('hidden');
        
        showToast('Email sending process completed', 'success');
    }
}
// Enhanced function to download failed emails with error details
function downloadFailedEmails() {
    // First try getting failed emails from the window object
    if (window.failedEmails && window.failedEmails.length > 0) {
        downloadFailedEmailsLocal(window.failedEmails);
    } else {
        // Fallback to server request
        const serverData = JSON.parse(localStorage.getItem('currentServer'));
        if (!serverData || !serverData.ip) {
            showToast('No server details found', 'error');
            return;
        }
        
        showToast('Fetching failed emails...', 'info');
        
        fetch(`http://${serverData.ip}:5000/download-failed-emails`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch failed emails');
                }
                return response.blob();
            })
            .then(blob => {
                // Create a download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'failed_emails.csv';
                
                // Append to the document and trigger click
                document.body.appendChild(a);
                a.click();
                
                // Clean up
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showToast('Failed emails downloaded successfully', 'success');
            })
            .catch(error => {
                console.error('Download error:', error);
                showToast(`Failed to download: ${error.message}`, 'error');
            });
    }
}

// Function to handle local download of failed emails
function downloadFailedEmailsLocal(failedEmails) {
    try {
        // Create CSV content
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Email,SMTP_Username,SMTP_Server,Error,Timestamp\n";
        
        failedEmails.forEach(record => {
            // Escape CSV values properly
            const email = `"${record.email.replace(/"/g, '""')}"`;
            const smtpUser = `"${(record.smtp_username || '').replace(/"/g, '""')}"`;
            const smtpServer = `"${(record.smtp_server || '').replace(/"/g, '""')}"`;
            const error = `"${(record.error || '').replace(/"/g, '""')}"`;
            const timestamp = `"${(record.timestamp || new Date().toISOString()).replace(/"/g, '""')}"`;
            
            csvContent += `${email},${smtpUser},${smtpServer},${error},${timestamp}\n`;
        });
        
        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "failed_emails.csv");
        document.body.appendChild(link);
        
        // Trigger download
        link.click();
        
        // Clean up
        document.body.removeChild(link);
        
        showToast('Failed emails downloaded successfully', 'success');
    } catch (error) {
        console.error('Error downloading failed emails:', error);
        showToast('Failed to download failed emails', 'error');
    }
}
    
    // Process and preview CSV file
    function processCSVPreview(file, previewHeaderId, previewBodyId, rowCountId, previewContainerId, hoverPreviewId, maxPreviewRows = 5) {
        if (!file) return;
        
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const contents = e.target.result;
            const lines = contents.split(/\r\n|\n/);
            
            // Check if file has data
            if (lines.length === 0) {
                showToast('CSV file is empty', 'error');
                return;
            }
            
            // Get headers
            const headers = lines[0].split(',');
            
            // Build header row
            const headerRow = document.getElementById(previewHeaderId);
            headerRow.innerHTML = '';
            headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-2 py-1 text-left';
                th.textContent = header.trim();
                headerRow.appendChild(th);
            });
            
            // Build body rows (limited to maxPreviewRows)
            const previewBody = document.getElementById(previewBodyId);
            previewBody.innerHTML = '';
            
            const rowsToDisplay = Math.min(lines.length - 1, maxPreviewRows);
            for (let i = 1; i <= rowsToDisplay; i++) {
                if (!lines[i] || lines[i].trim() === '') continue;
                
                const row = document.createElement('tr');
                const cells = lines[i].split(',');
                
                cells.forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'px-2 py-1 border-t';
                    td.textContent = cell.trim();
                    row.appendChild(td);
                });
                
                previewBody.appendChild(row);
            }
            
            // Update row count
            const rowCount = document.getElementById(rowCountId);
            if (rowCount) {
                rowCount.textContent = lines.length - 1;
            }
            
            // Show preview container
            const previewContainer = document.getElementById(previewContainerId);
            if (previewContainer) {
                previewContainer.classList.remove('hidden');
            }
            
            // Set up hover preview
            const hoverPreview = document.getElementById(hoverPreviewId);
            if (hoverPreview) {
                // Clone the header row for hover preview
                const hoverHeaderRow = document.getElementById(hoverPreviewId + 'Header');
                hoverHeaderRow.innerHTML = headerRow.innerHTML;
                
                // Populate hover preview with all rows (up to 20)
                const hoverPreviewBody = document.getElementById(hoverPreviewId + 'Body');
                hoverPreviewBody.innerHTML = '';
                
                const hoverRowsToDisplay = Math.min(lines.length - 1, 20);
                for (let i = 1; i <= hoverRowsToDisplay; i++) {
                    if (!lines[i] || lines[i].trim() === '') continue;
                    
                    const row = document.createElement('tr');
                    const cells = lines[i].split(',');
                    
                    cells.forEach(cell => {
                        const td = document.createElement('td');
                        td.className = 'px-2 py-1 border-t';
                        td.textContent = cell.trim();
                        row.appendChild(td);
                    });
                    
                    hoverPreviewBody.appendChild(row);
                }
                
                hoverPreview.classList.remove('hidden');
            }
        };
        
        reader.readAsText(file);
    }
    
    // Function to display server details
    function displayServerDetails(server) {
        // Hide welcome section if it exists
        const welcomeSection = document.getElementById('welcomeSection');
        if (welcomeSection) {
            welcomeSection.classList.add('hidden');
        }
        
        // Show server details section in sidebar
        const sidebarServerDetails = document.getElementById('sidebarServerDetails');
        if (sidebarServerDetails) {
            sidebarServerDetails.classList.remove('hidden');
        }
        
        // Update server IP
        const serverIP = document.getElementById('serverIP');
        if (serverIP) {
            // First, check if the element already has a span
            let span = serverIP.querySelector('span');
            if (!span) {
                // If not, create one
                span = document.createElement('span');
                serverIP.innerHTML = '';
                serverIP.appendChild(span);
            }
            
            // Now update the span content
            span.textContent = server.ip;
        }
        
        // Update server type
        const serverTypeText = server.type === 'single' ? 'Single (2 hours)' : 'Unlimited (12 hours)';
        const serverType = document.getElementById('serverType');
        if (serverType) {
            serverType.textContent = serverTypeText;
        }
        
        // Format and update dates
        const createdAt = document.getElementById('createdAt');
        const expiresAt = document.getElementById('expiresAt');
        
        if (createdAt) {
            createdAt.textContent = formatDate(server.createdAt);
        }
        
        if (expiresAt) {
            expiresAt.textContent = formatDate(server.expiresAt);
        }
        
        // Reset connection status
        const serverStatus = document.getElementById('serverStatus');
        const serverError = document.getElementById('serverError');
        const connectBtn = document.getElementById('connectBtn');
        const connectingSpinner = document.getElementById('connectingSpinner');
        const emailSenderSection = document.getElementById('emailSenderSection');
        
        if (serverStatus) serverStatus.classList.add('hidden');
        if (serverError) serverError.classList.add('hidden');
        if (connectBtn) connectBtn.classList.remove('hidden');
        if (connectingSpinner) connectingSpinner.classList.add('hidden');
        if (emailSenderSection) emailSenderSection.classList.add('hidden');
        
        // Update status badge
        updateStatusBadge('running');
        
        // Toggle "Get New IP" button based on server type
        const getNewIPBtn = document.getElementById('getNewIPBtn');
        if (getNewIPBtn) {
            if (server.type === 'unlimited') {
                getNewIPBtn.classList.remove('hidden');
            } else {
                getNewIPBtn.classList.add('hidden');
            }
        }
        
        // Store server details
        localStorage.setItem('currentServer', JSON.stringify({
            id: server._id,
            ip: server.ip,
            type: server.type,
            createdAt: server.createdAt,
            expiresAt: server.expiresAt,
            connected: false
        }));
    }
    
    // Show server connected state
    function showServerConnected() {
        const serverStatus = document.getElementById('serverStatus');
        const serverStatusText = document.getElementById('serverStatusText');
        const connectBtn = document.getElementById('connectBtn');
        const connectingSpinner = document.getElementById('connectingSpinner');
        const emailSenderSection = document.getElementById('emailSenderSection');
        
        if (serverStatus) serverStatus.classList.remove('hidden');
        if (serverStatusText) serverStatusText.textContent = 'Connected';
        if (connectBtn) connectBtn.classList.add('hidden');
        if (connectingSpinner) connectingSpinner.classList.add('hidden');
        if (emailSenderSection) emailSenderSection.classList.remove('hidden');
        
        // Update status badge
        updateStatusBadge('connected');
        
        // Update localStorage
        const serverData = JSON.parse(localStorage.getItem('currentServer'));
        if (serverData) {
            serverData.connected = true;
            localStorage.setItem('currentServer', JSON.stringify(serverData));
        }
    }
    
    // Function to display server error
    function showServerError(message) {
        const serverError = document.getElementById('serverError');
        const serverErrorText = document.getElementById('serverErrorText');
        const connectBtn = document.getElementById('connectBtn');
        const connectingSpinner = document.getElementById('connectingSpinner');
        
        if (serverErrorText) serverErrorText.textContent = message;
        if (serverError) serverError.classList.remove('hidden');
        if (connectBtn) connectBtn.classList.remove('hidden');
        if (connectingSpinner) connectingSpinner.classList.add('hidden');
        
        // Update status badge
        updateStatusBadge('error');
    }
    
    // Fix Molly Points refresh functionality
    function refreshPoints() {
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/';
        return;
    }
    
    showLoading('Refreshing Credits...');
    
    // Make a dedicated endpoint call for points
    fetch('/api/user/points', {
        headers: {
            'Authorization': `Bearer ${token}`
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to refresh Credits');
        }
        return response.json();
    })
    .then(data => {
        // Check if we have points data
        if (data && typeof data.mollyPoints !== 'undefined') {
            // Update user object in localStorage
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            user.mollyPoints = data.mollyPoints;
            localStorage.setItem('user', JSON.stringify(user));
            
            // Update UI
            const mollyPointsElem = document.getElementById('mollyPoints');
            const mollyPointsDropdownElem = document.getElementById('mollyPointsDropdown');
            
            if (mollyPointsElem) mollyPointsElem.textContent = data.mollyPoints;
            if (mollyPointsDropdownElem) mollyPointsDropdownElem.textContent = data.mollyPoints;
            
            showToast('Credits refreshed successfully', 'success');
        } else {
            throw new Error('User data not found in response');
        }
    })
    .catch(error => {
        console.error('Error refreshing points:', error);
        
        // Fallback to servers endpoint if dedicated endpoint fails
        fetch('/api/servers', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.user && typeof data.user.mollyPoints !== 'undefined') {
                // Update user object in localStorage
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                user.mollyPoints = data.user.mollyPoints;
                localStorage.setItem('user', JSON.stringify(user));
                
                // Update UI
                const mollyPointsElem = document.getElementById('mollyPoints');
                const mollyPointsDropdownElem = document.getElementById('mollyPointsDropdown');
                
                if (mollyPointsElem) mollyPointsElem.textContent = user.mollyPoints;
                if (mollyPointsDropdownElem) mollyPointsDropdownElem.textContent = user.mollyPoints;
                
                showToast('Credits refreshed successfully', 'success');
            } else {
                showToast('Failed to refresh Credits. Please try again.', 'error');
            }
        })
        .catch(err => {
            showToast('Failed to refresh Credits. Please try again.', 'error');
        });
    })
    .finally(() => {
        hideLoading();
    });
}
    
    // Modified function to create a server - now handles asynchronous responses
    async function createServer(type) {
        if (serverModalError) {
            serverModalError.classList.add('hidden');
        }
        if (serverModal) {
            serverModal.classList.add('hidden'); // Hide modal first
        }
        showLoading(`Creating ${type} server...`);
        
        try {
            const token = localStorage.getItem('token');
            
            // Create a custom AbortController with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000);
            
            const response = await fetch('/api/create-server', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ type: type }),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            const data = await response.json();
            
            // If we got a 409 Conflict response with existing server info
            if (response.status === 409 && data.has_existing_server) {
                // Show error message
                showToast(data.message, 'error');
                
                // If we're on the dashboard page, show server details
                const sidebarServerDetails = document.getElementById('sidebarServerDetails');
                if (sidebarServerDetails && sidebarServerDetails.classList.contains('hidden')) {
                    sidebarServerDetails.classList.remove('hidden');
                    
                    // Highlight the terminate button
                    const terminateBtn = document.getElementById('terminateBtn');
                    if (terminateBtn) {
                        terminateBtn.classList.add('animate-pulse', 'ring-2', 'ring-red-500');
                        
                        // Remove highlight after 3 seconds
                        setTimeout(() => {
                            terminateBtn.classList.remove('animate-pulse', 'ring-2', 'ring-red-500');
                        }, 3000);
                    }
                }
            } else if (!response.ok) {
                // Handle other
                } else if (!response.ok) {
                // Handle other errors
                throw new Error(data.message || 'Failed to create server');
            } else {
                // Success path - server created successfully
                // Update user's Molly points
                const user = JSON.parse(localStorage.getItem('user'));
                user.mollyPoints -= (type === 'single' ? 100 : 2000);
                localStorage.setItem('user', JSON.stringify(user));
                
                const mollyPointsElem = document.getElementById('mollyPoints');
                if (mollyPointsElem) {
                    mollyPointsElem.textContent = user.mollyPoints;
                }
                
                const mollyPointsDropdownElem = document.getElementById('mollyPointsDropdown');
                if (mollyPointsDropdownElem) {
                    mollyPointsDropdownElem.textContent = user.mollyPoints;
                }
                
                // Display server details
                displayServerDetails(data.server);
                
                // Update status badge to show initializing
                updateStatusBadge('initializing');
                
                // Toggle "Get New IP" button based on server type
                const getNewIPBtn = document.getElementById('getNewIPBtn');
                if (getNewIPBtn) {
                    if (type === 'unlimited') {
                        getNewIPBtn.classList.remove('hidden');
                    } else {
                        getNewIPBtn.classList.add('hidden');
                    }
                    
                    // Disable the button until server is ready
                    getNewIPBtn.disabled = true;
                    getNewIPBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                // Disable terminate button until server is ready
                const terminateBtn = document.getElementById('terminateBtn');
                if (terminateBtn) {
                    terminateBtn.disabled = true;
                    terminateBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                // Show success message
                showToast('Server creation initiated! Server will be ready shortly.', 'success');
                
                // Start polling for server status
                if (data.server._id) {
                    pollServerStatus(data.server._id);
                }
            }
        } catch (error) {
    console.error('Server creation error:', error);
    
    if (error.message.includes('timed out') || error.name === 'AbortError') {
        showToast("Server creation request is taking longer than expected. Checking status...", 'warning');
        
        // Wait a moment then check server status
        setTimeout(() => {
            checkExistingServers();
        }, 5000);
    } else if (serverModalErrorText && serverModal && serverModalError) {
        serverModalErrorText.textContent = error.message || 'Failed to create server';
        serverModal.classList.remove('hidden'); // Show modal again to display error
        serverModalError.classList.remove('hidden');
    } else {
        showToast(`Failed to create server: ${error.message}`, 'error');
    }
} finally {
    hideLoading();
}
}
    
    // Modified IP rotation function
    async function rotateServerIP() {
        if (newIPModal) {
            newIPModal.classList.add('hidden');
        }
        showLoading('Swapping IP');
        
        try {
            const serverData = JSON.parse(localStorage.getItem('currentServer'));
            if (!serverData || !serverData.id) {
                throw new Error('No server details found');
            }
            
            const token = localStorage.getItem('token');
            
            // Create a custom AbortController with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 45000);
            
            // Call the rotate-ip endpoint
            const response = await fetch('/api/rotate-ip', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ server_id: serverData.id }),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            const data = await handleApiResponse(response);
            
            // Update the UI with the new server details
            displayServerDetails(data.server);
            
            // Update status badge to show IP rotation in progress
            updateStatusBadge('connecting');
            
            // Reset connection status since we have a new IP
            const serverStatus = document.getElementById('serverStatus');
            const serverError = document.getElementById('serverError');
            const connectBtn = document.getElementById('connectBtn');
            const connectingSpinner = document.getElementById('connectingSpinner');
            const emailSenderSection = document.getElementById('emailSenderSection');
            
            if (serverStatus) serverStatus.classList.add('hidden');
            if (serverError) serverError.classList.add('hidden');
            if (connectBtn) connectBtn.classList.remove('hidden');
            if (connectingSpinner) connectingSpinner.classList.add('hidden');
            if (emailSenderSection) emailSenderSection.classList.add('hidden');
            
            // Disable buttons during IP rotation
            const getNewIPBtn = document.getElementById('getNewIPBtn');
            const terminateBtn = document.getElementById('terminateBtn');
            
            if (getNewIPBtn) {
                getNewIPBtn.disabled = true;
                getNewIPBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            if (terminateBtn) {
                terminateBtn.disabled = true;
                terminateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // Update the stored server data
            localStorage.setItem('currentServer', JSON.stringify({
                id: data.server._id,
                ip: data.server.ip,
                type: data.server.type,
                createdAt: data.server.createdAt,
                expiresAt: data.server.expiresAt,
                connected: false
            }));
            
            // Start polling for server status
            pollServerStatus(data.server._id);
            
            // Show success message
            showToast('IP rotation initiated! New IP will be ready shortly.', 'success');
        } catch (error) {
    console.error('IP rotation error:', error);
    
    if (error.message.includes('timed out') || error.name === 'AbortError') {
        showToast("IP rotation request is taking longer than expected. It may still complete successfully.", 'warning');
        
        // Wait a moment then check server status
        setTimeout(() => {
            const serverData = JSON.parse(localStorage.getItem('currentServer'));
            if (serverData && serverData.id) {
                pollServerStatus(serverData.id);
            }
        }, 5000);
    } else {
        showToast(`Failed to swap IP: ${error.message}`, 'error');
    }
} finally {
    hideLoading();
}
    }
    
    // Update email progress indicators
    function updateEmailProgress(data) {
        const smtpFailed = document.getElementById('smtpFailed');
        const smtpSuccess = document.getElementById('smtpSuccess');
        const emailsSent = document.getElementById('emailsSent');
        const emailsFailed = document.getElementById('emailsFailed');
        const progressPercentage = document.getElementById('progressPercentage');
        const progressBar = document.getElementById('progressBar');
        const failedEmailsSection = document.getElementById('failedEmailsSection');
        const sendBtn = document.getElementById('sendBtn');
        const sendingBtn = document.getElementById('sendingBtn');
        const stopSendingBtn = document.getElementById('stopSendingBtn');
        
        if (smtpFailed) smtpFailed.textContent = data.smtpFailed;
        if (smtpSuccess) smtpSuccess.textContent = data.smtpSuccess;
        if (emailsSent) emailsSent.textContent = data.emailsSent;
        if (emailsFailed) emailsFailed.textContent = data.emailsFailed;
        
        const total = data.emailsSent + data.emailsFailed;
        const totalEmails = parseInt(data.totalEmails);
        const percentage = totalEmails > 0 ? Math.round((total / totalEmails) * 100) : 0;
        
        if (progressPercentage) progressPercentage.textContent = percentage;
        if (progressBar) progressBar.style.width = `${percentage}%`;
        
        // Show failed emails section if there are any failed emails
        if (data.emailsFailed > 0 && failedEmailsSection) {
            failedEmailsSection.classList.remove('hidden');
        }
        
        if (total >= totalEmails && !data.isRunning) {
            // Re-enable send button when process is complete
            if (sendBtn) sendBtn.classList.remove('hidden');
            if (sendingBtn) sendingBtn.classList.add('hidden');
            if (stopSendingBtn) stopSendingBtn.classList.add('hidden');
            
            showToast('Email sending process completed', 'success');
        }
    }
    
    // Set up WebSocket connection
    function setupWebSocket(serverIp) {
    try {
        console.log("Setting up Socket.IO connection to", serverIp);
        // Use Socket.IO client with improved connection options
        const socket = io(`http://${serverIp}:5000`, {
            transports: ['websocket', 'polling'], // Try websocket first, fallback to polling
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000 // Longer timeout
        });
        
        // Store socket in global variable
        activeSocket = socket;
        
        socket.on('connect', function() {
            console.log('Socket.IO connection established');
            showToast('Real-time connection established', 'success');
        });
        
        socket.on('status', function(data) {
            console.log('Received status update:', data);
            updateEmailProgress(data);
        });
        
        socket.on('smtp_validation', function(data) {
            console.log('Received SMTP validation results:', data);
            displaySmtpValidationResults(data);
        });
        socket.on('email_failures', function(data) {
            console.log('Received email failures:', data);
            if (data.failedEmails && data.failedEmails.length > 0) {
                window.failedEmails = data.failedEmails;
            }
        });
        
        socket.on('connect_error', function(error) {
            console.error('Socket.IO connection error:', error);
            showToast('Connection error. Retrying...', 'warning');
        });
        
        socket.on('reconnect', function(attemptNumber) {
            console.log('Socket.IO reconnected after', attemptNumber, 'attempts');
            showToast('Connection re-established', 'success');
        });
        
        socket.on('reconnect_failed', function() {
            console.error('Socket.IO reconnection failed');
            showToast('Failed to establish real-time connection. Status updates may be delayed.', 'error');
            
            // Re-enable send button when all reconnection attempts fail
            enableSendButton();
        });
        
        socket.on('disconnect', function(reason) {
            console.log('Socket.IO disconnected:', reason);
            
            if (reason === 'io server disconnect') {
                // The server has forcefully disconnected the socket
                showToast('Server disconnected. Trying to reconnect...', 'warning');
                socket.connect(); // Manual reconnection
            }
            
            // Re-enable send button when socket disconnects
            enableSendButton();
        });
        
        return socket;
    } catch (error) {
        console.error('Error setting up Socket.IO:', error);
        showToast('Failed to set up real-time updates', 'warning');
        
        // Re-enable send button if socket fails
        enableSendButton();
        
        return null;
    }
}

// Helper function to re-enable send button
function enableSendButton() {
    const sendBtn = document.getElementById('sendBtn');
    const sendingBtn = document.getElementById('sendingBtn');
    const stopSendingBtn = document.getElementById('stopSendingBtn');
    
    if (sendBtn) sendBtn.classList.remove('hidden');
    if (sendingBtn) sendingBtn.classList.add('hidden');
    if (stopSendingBtn) stopSendingBtn.classList.add('hidden');
    
    // Clear the active socket reference
    activeSocket = null;
}
    
    // Set up CSV file preview functionality
    function setupCSVPreviewFunctionality() {
        const smtpFileInput = document.getElementById('smtpFile');
        const emailFileInput = document.getElementById('emailFile');
        
        if (smtpFileInput) {
            smtpFileInput.addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name;
                const fileNameElement = document.getElementById('smtpFileName');
                if (fileName) {
                    fileNameElement.textContent = fileName;
                    fileNameElement.classList.remove('hidden');
                    document.getElementById('clearSmtpBtn').classList.remove('hidden');
                    
                    // Process CSV preview
                    processCSVPreview(
                        e.target.files[0], 
                        'smtpPreviewHeader', 
                        'smtpPreviewBody', 
                        'smtpRowCount', 
                        'smtpPreviewContainer',
                        'smtpHoverPreview'
                    );
                } else {
                    fileNameElement.classList.add('hidden');
                    document.getElementById('clearSmtpBtn').classList.add('hidden');
                    document.getElementById('smtpPreviewContainer').classList.add('hidden');
                    document.getElementById('smtpHoverPreview').classList.add('hidden');
                }
            });
        }
        
        if (emailFileInput) {
            emailFileInput.addEventListener('change', function(e) {
                const fileName = e.target.files[0]?.name;
                const fileNameElement = document.getElementById('emailFileName');
                if (fileName) {
                    fileNameElement.textContent = fileName;
                    fileNameElement.classList.remove('hidden');
                    document.getElementById('clearEmailBtn').classList.remove('hidden');
                    
                    // Process CSV preview
                    processCSVPreview(
                        e.target.files[0], 
                        'emailPreviewHeader', 
                        'emailPreviewBody', 
                        'emailRowCount', 
                        'emailPreviewContainer',
                        'emailHoverPreview'
                    );
                } else {
                    fileNameElement.classList.add('hidden');
                    document.getElementById('clearEmailBtn').classList.add('hidden');
                    document.getElementById('emailPreviewContainer').classList.add('hidden');
                    document.getElementById('emailHoverPreview').classList.add('hidden');
                }
            });
        }
        
        // Add clear button functionality
        const clearSmtpBtn = document.getElementById('clearSmtpBtn');
        if (clearSmtpBtn) {
            clearSmtpBtn.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('smtpFile').value = '';
                document.getElementById('smtpFileName').classList.add('hidden');
                clearSmtpBtn.classList.add('hidden');
                document.getElementById('smtpPreviewContainer').classList.add('hidden');
                document.getElementById('smtpHoverPreview').classList.add('hidden');
            });
        }
        
        const clearEmailBtn = document.getElementById('clearEmailBtn');
        if (clearEmailBtn) {
            clearEmailBtn.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('emailFile').value = '';
                document.getElementById('emailFileName').classList.add('hidden');
                clearEmailBtn.classList.add('hidden');
                document.getElementById('emailPreviewContainer').classList.add('hidden');
                document.getElementById('emailHoverPreview').classList.add('hidden');
            });
        }
    }
    
    // Set up stop sending button
    function setupStopSendingButton() {
        const stopSendingBtn = document.getElementById('stopSendingBtn');
        
        if (stopSendingBtn) {
            stopSendingBtn.addEventListener('click', async function() {
                if (!activeSocket) {
                    showToast('No active email sending process to stop', 'warning');
                    return;
                }
                
                try {
                    const serverData = JSON.parse(localStorage.getItem('currentServer'));
                    if (!serverData || !serverData.ip) {
                        showToast('Server details not found', 'error');
                        return;
                    }
                    
                    // Set the flag to indicate stopping was requested
                    stopRequested = true;
                    
                    // Show stopping indicator
                    showToast('Stopping email sending process...', 'info');
                    
                    // Send stop signal to server
                    const response = await fetch(`http://${serverData.ip}:5000/stop-sending`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        showToast('Email sending stopped successfully', 'success');
                        
                        // Re-enable send button
                        const sendBtn = document.getElementById('sendBtn');
                        const sendingBtn = document.getElementById('sendingBtn');
                        
                        if (sendBtn) sendBtn.classList.remove('hidden');
                        if (sendingBtn) sendingBtn.classList.add('hidden');
                        if (stopSendingBtn) stopSendingBtn.classList.add('hidden');
                        
                        // Clean up socket if needed
                        if (activeSocket) {
                            activeSocket.disconnect();
                            activeSocket = null;
                        }
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to stop email sending');
                    }
                } catch (error) {
                    console.error('Stop sending error:', error);
                    showToast(`Failed to stop sending: ${error.message}`, 'error');
                }
            });
        }
    }
    
    // Set up custom tag UI
    function setupCustomTagUI() {
        // Add custom tag button click handler
        document.getElementById('addCustomTagBtn').addEventListener('click', () => {
            document.getElementById('customTagModal').classList.remove('hidden');
            updateTagPreview();
        });
        
        // Cancel custom tag button
        document.getElementById('cancelCustomTagBtn').addEventListener('click', () => {
            document.getElementById('customTagModal').classList.add('hidden');
        });
        
        // Click outside to close
        document.getElementById('customTagModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('customTagModal')) {
                document.getElementById('customTagModal').classList.add('hidden');
            }
        });
        
        // Update preview when inputs change
        document.getElementById('tagName').addEventListener('input', updateTagPreview);
        document.getElementById('tagType').addEventListener('change', updateTagPreview);
        document.getElementById('tagCase').addEventListener('change', updateTagPreview);
        document.getElementById('tagLength').addEventListener('input', updateTagPreview);
        
        // Add tag button
        document.getElementById('addCustomTagConfirmBtn').addEventListener('click', () => {
            const name = document.getElementById('tagName').value.trim();
            
            if (!name) {
                showToast('Please enter a tag name', 'error');
                return;
            }
            
            // Check for invalid characters
            if (!/^[a-zA-Z0-9_]+$/.test(name)) {
                showToast('Tag name can only contain letters, numbers, and underscores', 'error');
                return;
            }
            
            // Add to custom tags
            customTags[name] = {
                type: document.getElementById('tagType').value,
                case: document.getElementById('tagCase').value,
                length: parseInt(document.getElementById('tagLength').value)
            };
            
            // Add to UI
            addCustomTagToUI(name, customTags[name]);
            
            // Close modal
            document.getElementById('customTagModal').classList.add('hidden');
            showToast(`Custom tag ${name} added successfully`, 'success');
        });
    }
    
    // Check for existing servers
    async function checkExistingServers() {
        const token = localStorage.getItem('token');
        
        try {
            // Create a custom AbortController with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            
            const response = await fetch('/api/servers', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            const data = await handleApiResponse(response);
            if (data.servers && data.servers.length > 0) {
                // Display the most recent server
                const server = data.servers[0];
                displayServerDetails(server);
                
                // Check if the server is already connected
                const serverData = JSON.parse(localStorage.getItem('currentServer') || '{}');
                if (serverData.connected) {
                    showServerConnected();
                }
                
                // If the server is in a transitional state, start polling
                if (server.status && ['starting', 'rotating_ip', 'rechecking'].includes(server.status)) {
                    pollServerStatus(server._id);
                }
            }
        } catch (error) {
            console.error('Error fetching servers:', error);
            showToast(`Failed to fetch servers: ${error.message}`, 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
    // Set up download buttons
    const downloadSmtpLogsBtn = document.getElementById('downloadSmtpLogsBtn');
    if (downloadSmtpLogsBtn) {
        downloadSmtpLogsBtn.addEventListener('click', function() {
            downloadSmtpLogs();
        });
    }
    
    const downloadFailedBtn = document.getElementById('downloadFailedBtn');
    if (downloadFailedBtn) {
        downloadFailedBtn.addEventListener('click', function() {
            downloadFailedEmails();
        });
    }
});
    
    // Make sure tag elements have direct click handlers
    document.addEventListener('DOMContentLoaded', function() {
        // Add click handlers to standard tags
        document.querySelectorAll('.tag-item').forEach(element => {
            // Skip if already has a handler
            if (element.hasAttribute('data-has-handler')) return;
            
            // Mark as having a handler
            element.setAttribute('data-has-handler', 'true');
            
            // Get the tag from data attribute or span content
            const tagSpan = element.querySelector('span');
            const tag = element.getAttribute('data-tag') || 
                    (tagSpan ? '$' + tagSpan.textContent.trim() : null);
            
            if (tag) {
                // Remove any existing onclick attribute
                if (element.hasAttribute('onclick')) {
                    element.removeAttribute('onclick');
                }
                
                // Add a direct click event listener
                element.addEventListener('click', function(e) {
                    // Don't trigger if clicking the remove button
                    if (e.target.classList.contains('fa-times')) return;
                    
                    e.preventDefault();
                    copyTagToClipboard(tag);
                });
            }
        });
        
        // Add a delegated handler for the custom tags container
        const customTagsList = document.getElementById('customTagsList');
        if (customTagsList) {
            // Remove any existing handlers first
            const oldHandler = customTagsList.getAttribute('data-handler-installed');
            if (!oldHandler) {
                customTagsList.setAttribute('data-handler-installed', 'true');
                
                customTagsList.addEventListener('click', function(e) {
                    // Find the closest tag element or icon
                    const tagElement = e.target.closest('.inline-flex.items-center') || 
                                    (e.target.classList.contains('fa-copy') ? e.target.parentElement : null);
                    
                    if (tagElement && !e.target.classList.contains('fa-times')) {
                        // Get the tag name from the span text and prepend $
                        const tagSpan = tagElement.querySelector('span');
                        if (tagSpan) {
                            const tagName = tagSpan.textContent.trim();
                            copyTagToClipboard('$' + tagName);
                            e.stopPropagation();
                        }
                    }
                });
            }
        }
    });
    
    // Load user data
    document.addEventListener('DOMContentLoaded', async function() {
        // Check if user is logged in
        const userData = localStorage.getItem('user');
        const token = localStorage.getItem('token');
        
        if (!userData || !token) {
            window.location.href = '/';
            return;
        }
        
        try {
            const user = JSON.parse(userData);
            document.getElementById('username').textContent = user.username;
            document.getElementById('userInitial').textContent = user.username.charAt(0).toUpperCase();
            document.getElementById('usernameDropdown').textContent = user.username;
            document.getElementById('mollyPoints').textContent = user.mollyPoints;
            document.getElementById('mollyPointsDropdown').textContent = user.mollyPoints;
            
            // Check if server exists
            showLoading('Checking for existing servers...');
            await checkExistingServers();
            
            // Set up CSV file preview functionality
            setupCSVPreviewFunctionality();
            
            // Set up custom tag UI elements
            setupCustomTagUI();
    
            // Set up stop sending button
            setupStopSendingButton();
            
            // Set up server creation handlers
            const singleServerOption = document.getElementById('singleServerOption');
            const unlimitedServerOption = document.getElementById('unlimitedServerOption');
            
            if (singleServerOption) {
                singleServerOption.onclick = function() {
                    createServer('single');
                };
            }
            
            if (unlimitedServerOption) {
                unlimitedServerOption.onclick = function() {
                    createServer('unlimited');
                };
            }
            
            // Set up refresh points button handlers
            const refreshPointsBtn = document.getElementById('refreshPointsBtn');
            const refreshPointsDropdownBtn = document.getElementById('refreshPointsDropdownBtn');
            
            if (refreshPointsBtn) {
                refreshPointsBtn.onclick = function(e) {
                    e.preventDefault();
                    refreshPoints();
                };
            }
            
            if (refreshPointsDropdownBtn) {
                refreshPointsDropdownBtn.onclick = function(e) {
                    e.preventDefault();
                    refreshPoints();
                };
            }
            
            // Set up IP rotation button handler
            const confirmNewIPBtn = document.getElementById('confirmNewIPBtn');
            
            if (confirmNewIPBtn) {
                confirmNewIPBtn.onclick = function() {
                    rotateServerIP();
                };
            }
        } catch (error) {
            console.error('Error loading dashboard:', error);
            showToast('Error loading dashboard data', 'error');
        } finally {
            hideLoading();
        }
    });
    // Connect to server functionality
    document.addEventListener('DOMContentLoaded', function() {
        const connectBtn = document.getElementById('connectBtn');
        
        if (connectBtn) {
            connectBtn.addEventListener('click', async function() {
                const serverData = JSON.parse(localStorage.getItem('currentServer') || '{}');
                if (!serverData || !serverData.ip) {
                    showToast('No server details found', 'error');
                    return;
                }
                
                // Show connecting state
                const connectBtnElem = document.getElementById('connectBtn');
                const connectingSpinner = document.getElementById('connectingSpinner');
                const serverError = document.getElementById('serverError');
                
                if (connectBtnElem) connectBtnElem.classList.add('hidden');
                if (connectingSpinner) connectingSpinner.classList.remove('hidden');
                if (serverError) serverError.classList.add('hidden');
                
                // Update status badge
                updateStatusBadge('connecting');
                
                try {
                    // Create a timeout promise
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Connection timed out')), 20000);
                    });
                    
                    // Create fetch promise
                    const fetchPromise = fetch(`http://${serverData.ip}:5000/connect`);
                    
                    // Race them
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (response.ok) {
                        // Show email sender section
                        showServerConnected();
                        showToast('Connected to server successfully!', 'success');
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Server connection failed');
                    }
                } catch (error) {
                    console.error('Server connection error:', error);
                    
                    let errorMessage = 'Failed to connect to server.';
                    if (error.message.includes('timed out')) {
                        errorMessage = 'Connection timed out.';
                    } else if (error instanceof TypeError && error.message.includes('NetworkError')) {
                        errorMessage = 'Network error connecting to server.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showServerError(errorMessage);
                    showToast(`Connection failed: ${errorMessage}`, 'error');
                }
            });
        }
    });
    
    // Handle email form submission
    document.addEventListener('DOMContentLoaded', function() {
        const emailForm = document.getElementById('emailForm');
        
        if (emailForm) {
            emailForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const serverData = JSON.parse(localStorage.getItem('currentServer'));
                if (!serverData || !serverData.ip) {
                    showToast('No server details found', 'error');
                    return;
                }
                
                // Validate form
                const smtpFile = document.getElementById('smtpFile').files[0];
                const emailFile = document.getElementById('emailFile').files[0];
                
                // Reset error messages
                const smtpFileError = document.getElementById('smtpFileError');
                const emailFileError = document.getElementById('emailFileError');
                
                if (smtpFileError) smtpFileError.classList.add('hidden');
                if (emailFileError) emailFileError.classList.add('hidden');
                
                let hasError = false;
                
                if (!smtpFile) {
                    if (smtpFileError) {
                        smtpFileError.textContent = 'Please upload SMTP file';
                        smtpFileError.classList.remove('hidden');
                    }
                    hasError = true;
                }
                
                if (!emailFile) {
                    if (emailFileError) {
                        emailFileError.textContent = 'Please upload Email file';
                        emailFileError.classList.remove('hidden');
                    }
                    hasError = true;
                }
                
                if (hasError) return;
                
                // Show sending state
                const sendBtn = document.getElementById('sendBtn');
                const sendingBtn = document.getElementById('sendingBtn');
                const stopSendingBtn = document.getElementById('stopSendingBtn');
                
                if (sendBtn) sendBtn.classList.add('hidden');
                if (sendingBtn) sendingBtn.classList.remove('hidden');
                if (stopSendingBtn) stopSendingBtn.classList.remove('hidden');
                
                // Reset stop request flag
                stopRequested = false;
                
                // Create FormData
                const formData = new FormData();
                
                formData.append('smtpFile', smtpFile);
                formData.append('emailFile', emailFile);
                
                const subject = document.getElementById('subject');
                const senderName = document.getElementById('senderName');
                const plainMessage = document.getElementById('plainMessage');
                const htmlMessage = document.getElementById('htmlMessage');
                const attachmentType = document.getElementById('attachmentType');
                const delay = document.getElementById('delay');
                const threads = document.getElementById('threads');
                const attachmentHtml = document.getElementById('attachmentHtml');
                const attachmentName = document.getElementById('attachmentName');
                
                if (subject) formData.append('subject', subject.value);
                if (senderName) formData.append('senderName', senderName.value);
                if (plainMessage) formData.append('plainMessage', plainMessage.value);
                if (htmlMessage) formData.append('htmlMessage', htmlMessage.value);
                if (attachmentType) formData.append('attachmentType', attachmentType.value);
                if (delay) formData.append('delay', delay.value);
                if (threads) formData.append('threads', threads.value);
                if (attachmentHtml) formData.append('attachmentHtml', attachmentHtml.value);
                if (attachmentName) formData.append('attachmentName', attachmentName.value);
                
                // Include custom tags data
                formData.append('customTags', JSON.stringify(customTags));
                
                // Add date and invoice tags
                const dateValue = getCurrentFormattedDate();
                const invoiceValue = generateInvoiceNumber();
                formData.append('dateTags', JSON.stringify({
                    date: dateValue,
                    invoice: invoiceValue
                }));
                
                try {
                    // Create a timeout promise
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Request timed out')), 30000);
                    });
                    
                    // Create fetch promise
                    const fetchPromise = fetch(`http://${serverData.ip}:5000/send-mails`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Race them
                    const response = await Promise.race([fetchPromise, timeoutPromise]);
                    
                    if (response.ok) {
                        // Show progress section
                        const progressSection = document.getElementById('progressSection');
                        if (progressSection) progressSection.classList.remove('hidden');
                        
                        // Reset progress indicators
                        const smtpFailed = document.getElementById('smtpFailed');
                        const smtpSuccess = document.getElementById('smtpSuccess');
                        const emailsSent = document.getElementById('emailsSent');
                        const emailsFailed = document.getElementById('emailsFailed');
                        const progressPercentage = document.getElementById('progressPercentage');
                        const progressBar = document.getElementById('progressBar');
                        
                        if (smtpFailed) smtpFailed.textContent = '0';
                        if (smtpSuccess) smtpSuccess.textContent = '0';
                        if (emailsSent) emailsSent.textContent = '0';
                        if (emailsFailed) emailsFailed.textContent = '0';
                        if (progressPercentage) progressPercentage.textContent = '0';
                        if (progressBar) progressBar.style.width = '0%';
                        
                        // Set up Socket.IO for real-time updates
                        setupWebSocket(serverData.ip);
                        
                        showToast('Email sending process started', 'success');
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to start email sending process');
                    }
                } catch (error) {
                    console.error('Email sending error:', error);
                    
                    let errorMessage = 'Failed to send emails.';
                    if (error.message.includes('timed out')) {
                        errorMessage = 'Request timed out.';
                    } else if (error instanceof TypeError && error.message.includes('NetworkError')) {
                        errorMessage = 'Network error connecting to server.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showToast(`Email sending failed: ${errorMessage}`, 'error');
                    
                    // Reset sending state
                    if (sendBtn) sendBtn.classList.remove('hidden');
                    if (sendingBtn) sendingBtn.classList.add('hidden');
                    if (stopSendingBtn) stopSendingBtn.classList.add('hidden');
                }
            });
        }
    });
    
    // Download failed emails functionality
    document.addEventListener('DOMContentLoaded', function() {
        const downloadFailedBtn = document.getElementById('downloadFailedBtn');
        
        if (downloadFailedBtn) {
            downloadFailedBtn.addEventListener('click', async function() {
                const serverData = JSON.parse(localStorage.getItem('currentServer'));
                if (!serverData || !serverData.ip) {
                    showToast('No server details found', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`http://${serverData.ip}:5000/download-failed-emails`);
                    
                    if (response.ok) {
                        // Create a blob from the response
                        const blob = await response.blob();
                        
                        // Create a link to download the file
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = 'failed_emails.csv';
                        
                        // Append to the document and trigger click
                        document.body.appendChild(a);
                        a.click();
                        
                        // Clean up
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to download failed emails');
                    }
                } catch (error) {
                    console.error('Download error:', error);
                    showToast(`Failed to download: ${error.message}`, 'error');
                }
            });
        }
    });
    
    // Terminate server functionality
    // Enhanced server termination with better error handling
document.addEventListener('DOMContentLoaded', function() {
    const terminateBtn = document.getElementById('terminateBtn');
    
    if (terminateBtn) {
        terminateBtn.addEventListener('click', async function() {
            const serverData = JSON.parse(localStorage.getItem('currentServer') || '{}');
            if (!serverData || !serverData.id) {
                showToast('No server details found', 'error');
                return;
            }
            
            if (!confirm('Are you sure you want to terminate this server? This action cannot be undone.')) {
                return;
            }
            
            showLoading('Terminating server...');
            terminateBtn.disabled = true;
            terminateBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                const token = localStorage.getItem('token');
                
                // Create a timeout promise
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Termination request timed out. The server might still be terminating in the background.')), 30000);
                });
                
                // Create fetch promise
                const fetchPromise = fetch(`/api/terminate-server/${serverData.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Race them
                const response = await Promise.race([fetchPromise, timeoutPromise]);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to terminate server');
                }
                
                // Reset UI
                const welcomeSection = document.getElementById('welcomeSection');
                const sidebarServerDetails = document.getElementById('sidebarServerDetails');
                const emailSenderSection = document.getElementById('emailSenderSection');
                const progressSection = document.getElementById('progressSection');
                
                if (welcomeSection) welcomeSection.classList.remove('hidden');
                if (sidebarServerDetails) sidebarServerDetails.classList.add('hidden');
                if (emailSenderSection) emailSenderSection.classList.add('hidden');
                if (progressSection) progressSection.classList.add('hidden');
                
                // Clear server data
                localStorage.removeItem('currentServer');
                
                showToast('Server terminated successfully', 'success');
                
                // Refresh points after successful termination
                setTimeout(() => {
                    refreshPoints();
                }, 1000);
            } catch (error) {
                console.error('Server termination error:', error);
                
                if (error.message.includes('timed out')) {
                    showToast("Termination request was sent but took longer than expected. The server may still be terminating.", 'warning');
                    
                    // Check server status after a delay
                    setTimeout(() => {
                        // Refresh server list
                        showToast("Checking server status...", 'info');
                        checkExistingServers();
                    }, 5000);
                } else {
                    showToast(`Failed to terminate server: ${error.message}`, 'error');
                    
                    // Re-enable the terminate button after error
                    terminateBtn.disabled = false;
                    terminateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } finally {
                hideLoading();
            }
        });
    }
});
    
    // Logout functionality
    document.addEventListener('DOMContentLoaded', function() {
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutBtnDropdown = document.getElementById('logoutBtnDropdown');
        
        const logoutHandler = function() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            localStorage.removeItem('currentServer');
            window.location.href = '/';
        };
        
        if (logoutBtn) {
            logoutBtn.addEventListener('click', logoutHandler);
        }
        
        if (logoutBtnDropdown) {
            logoutBtnDropdown.addEventListener('click', logoutHandler);
        }
    });
    
    // Server modal functionality
    document.addEventListener('DOMContentLoaded', function() {
        const serverModal = document.getElementById('serverModal');
        const getServerBtn = document.getElementById('getServerBtn');
        const getServerBtnMain = document.getElementById('getServerBtnMain');
        const cancelServerBtn = document.getElementById('cancelServerBtn');
        const singleServerOption = document.getElementById('singleServerOption');
        const unlimitedServerOption = document.getElementById('unlimitedServerOption');
        const serverModalError = document.getElementById('serverModalError');
        const serverModalErrorText = document.getElementById('serverModalErrorText');
        
        // New IP modal functionality
        const newIPModal = document.getElementById('newIPModal');
        const getNewIPBtn = document.getElementById('getNewIPBtn');
        const cancelNewIPBtn = document.getElementById('cancelNewIPBtn');
        const confirmNewIPBtn = document.getElementById('confirmNewIPBtn');
        
        if (getServerBtn && getServerBtnMain) {
            // Modified: Open server modal with check for existing servers
            function openServerModal() {
                // Check if user already has an active server
                const existingServer = localStorage.getItem('currentServer');
                
                if (existingServer) {
                    const serverData = JSON.parse(existingServer);
                    // If server exists and hasn't expired
                    if (serverData && new Date(serverData.expiresAt) > new Date()) {
                        // Show error message instead of opening modal
                        showToast('You already have an active server. Please terminate it before creating a new one.', 'error');
                        
                        // Show server details section if it's hidden
                        const sidebarServerDetails = document.getElementById('sidebarServerDetails');
                        if (sidebarServerDetails) {
                            sidebarServerDetails.classList.remove('hidden');
                        }
                        
                        // Highlight the terminate button to draw attention to it
                        const terminateBtn = document.getElementById('terminateBtn');
                        if (terminateBtn) {
                            terminateBtn.classList.add('animate-pulse', 'ring-2', 'ring-red-500');
                            
                            // Remove highlight after 3 seconds
                            setTimeout(() => {
                                terminateBtn.classList.remove('animate-pulse', 'ring-2', 'ring-red-500');
                            }, 3000);
                        }
                        
                        return; // Don't open the modal
                    } else {
                        // Server exists but has expired, safe to open modal
                        if (serverModalError) {
                            serverModalError.classList.add('hidden');
                        }
                        if (serverModal) {
                            serverModal.classList.remove('hidden');
                        }
                    }
                } else {
                    // No server exists, safe to open modal
                    if (serverModalError) {
                        serverModalError.classList.add('hidden');
                    }
                    if (serverModal) {
                        serverModal.classList.remove('hidden');
                    }
                }
            }
            
            getServerBtn.addEventListener('click', openServerModal);
            getServerBtnMain.addEventListener('click', openServerModal);
        }
        
        if (cancelServerBtn && serverModal) {
            cancelServerBtn.addEventListener('click', function() {
                serverModal.classList.add('hidden');
            });
            
            // Close server modal when clicking outside
            serverModal.addEventListener('click', function(e) {
                if (e.target === serverModal) {
                    serverModal.classList.add('hidden');
                }
            });
        }
        
        if (getNewIPBtn && newIPModal) {
            // Open new IP modal
            getNewIPBtn.addEventListener('click', function() {
                // Show the confirmation modal
                newIPModal.classList.remove('hidden');
            });
        }
        
        if (cancelNewIPBtn && newIPModal) {
            cancelNewIPBtn.addEventListener('click', function() {
                newIPModal.classList.add('hidden');
            });
            
            // Close new IP modal when clicking outside
            newIPModal.addEventListener('click', function(e) {
                if (e.target === newIPModal) {
                    newIPModal.classList.add('hidden');
                }
            });
        }
    });
    </script>
</body>
</html>
